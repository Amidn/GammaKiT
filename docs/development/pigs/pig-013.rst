.. include:: ../../references.txt

.. _pig-013:

**********************************************
PIG 13 - Gammapy dependencies and distribution
**********************************************

* Author: Christoph Deil, Axel Donath, RÃ©gis Terrier, Brigitta Sipocz
* Created: June 6, 2019
* Accepted: tbd
* Status: draft
* Discussion: `GH 2218`_

Abstract
========

As preparation for the planned Gammapy v1.0 release fall 2019, we propose to
clarify which Gammapy dependencies are required and which ones are optional. We
also propose to increase the minimum required version for some dependencies.
Finally, we propose some updates to the Gammapy supported distribution channels
and installation instructions.

This represents that plan for 2019 to be implemented before v1.0. Things are
likely to evolve in the coming years, as Gammapy supports different projects,
especially CTA.

One reason to write a PIG for this (as opposed to just making these decisions
among the Gammapy lead developers or coordination committee) is to create an
opportunity for user feedback. Let us know what you think!

Introduction
============

In recent years, the Python packaging and distribution system has improved a
lot. Thanks to conda, we now have a way to ship up-to-date versions of Gammapy
and all dependencies on all supported platforms, the number of installation
issues reported by users has been very low in recent years.

Given this situation, we feel it is OK to be a bit less conservative in the
number of dependencies we use in Gammapy, as well as the minimum required
versions we support than we have been in previous years. However, we still
consider the choices made for Gammapy, and changes made in this PIG to be on the
conservative side, e.g. we avoid the use of ``scikit-image`` because 

Summary
=======

Here's a very short summary of the changes we propose:

- Drop support for Python 3.5, require Python 3.6 or later
- Drop support for Gammapy distribution via Macports
- Document and support ``pip install gammapy[extra]``

==========  ===============  ===============
Dependency  Gammapy 0.12     Gammapy 0.13
==========  ===============  ===============
astropy-healpix
Python      3.5  (Sep 2015)  3.6  (Dec 2016)
Numpy       1.10 (May 2016)  1.13 (Jun 2017)
Scipy       0.15 (Jan 2015)  1.0  (Oct 2017)
Astropy     2.0  (Jul 2017)  3.0? (Feb 2018)
regions     0.3  (Sep 2018)  0.4  (Jun 2019)
pyyaml
click
----------  ---------------  ---------------
matplotlib  2.1 (Oct 2017)   same
reproject
==========  ===============  ===============


Dependencies
============

- list which dependencies are required and optional?
- 

Versions
--------

Drop Python 3.5 support
-----------------------

As already mentioned in `pig-003`_, we now suggest to drop support for Python
3.5, already in the next release, Gammapy v0.13 in July 2019, for the following
reasons:

- We're not aware of any users that have to or even want to use Python 3.5, most
people use Gammapy on Python 3.6 or 3.7 now via conda.
- Reduce maintenance effort. conda-forge now only builds binaries for Python 3.6
and 3.7, so testing and supporting Python 3.5 for our large continuous
integration matrix will become more and more difficult in the coming months and
years.
- Allow the use of new language features, specifically f-strings and dict
everywhere (instead of a mix of OrderedDict and dict)

The first point is the most important one: the cost of supporting Python 3.5
isn't very high: if you want or need it, let us know!

Sunpy has already dropped Python 3.5 support in v1.0. Astropy still supports
Python 3.5, they will move to 3.6+ with Astropy 4.0 in early 2020.

Numpy
-----

Scipy
-----

astropy-healpix
---------------

For HEALPix we propose to change from `healpy`_ to `astropy-healpix`_. An
initial exploration whether ``astropy-healpix``_ has all the features we need
has already been done in `GH 1167`_.


Distribution
============

Most Gammapy users use ``conda`` and binaries created via ``conda-forge``.
Sufficient or do we want to support other distribution channels?

Wheels
------

The wheel binary package format was introduced as a standard for Python packages
in 2012 in `PEP 427`_. Most Python projects create and distribute wheels (see
https://pythonwheels.com), including packages much more complex than Gammapy
like Numpy, Scipy, Tensorflow.

At this time, we don't plan to offer wheels for Gammapy, but to only distribute
source distributions ``sdist`` at https://pypi.org/project/gammapy/ .

The reason is that binary wheels need to be built for each supported platform,
and they need to be distributed via PyPI, i.e. to create them a set of scripts
or continuous delivery configuration has to be set up and maintained by the
package maintainers. This is contrary and more difficult to achieve than binary
conda packages, where conda-forge exists as a separate build infrastructure and
tooling that starts by taking the ``sdist`` from PyPI and then uploading the
conda packages to anaconda.org.

At this point, nothing as simple as conda-forge has emerged for wheels, so
different projects or small group of projects set up their own system, e.g
https://github.com/MacPython/astropy-wheels for Astropy or
https://iscinumpy.gitlab.io/post/azure-devops-python-wheels/ for iminuit and the
scikit-hep packages.

TODO: change this section to suggest to build wheels via `astropy wheel-forge`_
and support that for now.

Actually, there is one platform where binary wheels for Gammapy and all
dependencies exits already. If you ``pip install gammapy`` on Raspberry Pi,
you'll get binary wheels thanks to this guy:
https://www.raspberrypi.org/blog/piwheels/

Macports
--------

We suggest to drop support for Macports, i.e. deleted the `Installation with
Macports`_ page from the installation instructions.

As can be seen in the `Gammapy in Macports`_ history, the last update was to
Gammapy v0.7 in March 2018, and not a single user has complained that Gammapy
wasn't updated since.

It could be that there is still interest and Macports users, and they e.g. only
use it to install Python and our dependencies, and then on top of that install
Gammapy with pip. If you use Macports and want ``port install py37-gammapy``,
let us know!

Others
------

- interest to add Homebrew packages?
- interest to 

Decision
========

tbd

.. _healpy: https://healpy.readthedocs.io
.. _astropy wheel-forge: https://github.com/astropy/wheel-forge
.. _astropy-healpix: http://astropy-healpix.readthedocs.io/
.. _GH 1167: https://github.com/gammapy/gammapy/pull/1167
.. _GH 2218: https://github.com/gammapy/gammapy/pull/2218
.. _GH 1658: https://github.com/gammapy/gammapy/pull/1658
.. _Installation with Macports: https://docs.gammapy.org/0.12/install/macports.html
.. _Gammapy in Macports: https://github.com/macports/macports-ports/commits/master/python/py-gammapy/Portfile
.. _PEP 427: https://www.python.org/dev/peps/pep-0427/