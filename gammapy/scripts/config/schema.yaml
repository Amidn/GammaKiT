---
"$schema": "http://json-schema.org/schema#"
"title": "Schema validation for Gammapy high-level interface API configuration"

type: object
additionalProperties: true
properties:

# Block: general
# General settings for the API
#
#    Logging settings for the session
#    Example values for the following properties
#    logging:
#        level: CRITICAL, ERROR, WARNING, INFO, DEBUG
#        filename: filename.log
#        filemode: w
#        format: "%(asctime)s - %(message)s"
#        datefmt: "%d-%b-%y %H:%M:%S"
#
#    Output folder where files will be stored
#    outdir:
#
    general:
        type: object
        default_all: {"logging": {}}
        default_basic: {"logging": {}}
        default_1d: {"logging": {}}
        default_3d: {"logging": {}}
        additionalProperties: false
        properties:
            outdir:
                type: string
                default_all: "."
                default_basic: "."
                default_1d: "."
            logging:
                type: object
                default_all: {}
                default_basic: {}
                default_1d: {}
                default_3d: {}
                additionalProperties: false
                properties:
                    level:
                        type: string
                        default_all: "INFO"
                        default_basic: "INFO"
                        default_1d: "INFO"
                        default_3d: "INFO"
                        enum: [CRITICAL, 50,
                               ERROR, 40,
                               WARNING, 30,
                               INFO, 20,
                               DEBUG, 10,
                               NOTSET]
                    filename: {type: string, default_all: gammapy.log}
                    filemode: {type: string, default_all: w}
                    format:
                        type: string
                        default_all: "%(asctime)s - %(message)s"
                    datefmt: {type: string, default_all: "%d-%b-%y %H:%M:%S"}
                required: [level]
                dependencies:
                    filemode: [filename]
        required: [logging]

# Block: observations
# Observations used in the analysis
#
#    Path to data store where to fetch observations
#    datastore:
#
#    List of filters with selection criteria
#    Example values for the following properties
#    filters:
#
#        - filter_type: sky_circle, angle_box, par_box, par_value, ids, all
#          Type of filter used
#
#          Properties when filter_type is "par_box"
#          frame: galactic, equatorial, icrs, fk5
#          lon: 83.633 deg
#          lat: 22.014 deg
#          radius: 1 deg
#          border: 1 deg
#
#          Properties when filter_type is "par_box" or "par_value"
#          variable: TARGET_NAME
#
#          Value to match declared variable
#          when filter_type is "par_value"
#          value_param: Crab
#
#          Value range with units to match declared variable
#          when filter_type is "par_box"
#          value_range:
#              - 265 deg
#              - 268 deg
#
#          List of observation identifiers when filter_type is "ids"
#          obs_ids:
#              - 23523
#              - 23526
#
#          inverted: true for not matching criteria
#          exclude: true to exclude matched observations
#
    observations:
        type: object
        default_all: {}
        default_basic: {}
        default_1d: {}
        default_3d: {}
        additionalProperties: false
        properties:
            datastore:
                type: string
                default_all: $GAMMAPY_DATA/hess-dl3-dr1
                default_basic: $GAMMAPY_DATA/hess-dl3-dr1
                default_1d: $GAMMAPY_DATA/hess-dl3-dr1
                default_3d:
                    $GAMMAPY_DATA/hess-dl3-dr1/hess-dl3-dr3-with-background.fits.gz
            filters:
                type: array
                default_all: [{}]
                default_basic: [{}]
                default_1d: [{}]
                default_3d: [{}]
                items:
                    type: object
                    additionalProperties: false
                    properties:
                        exclude: {type: boolean, default_all: false}
                        inverted: {type: boolean, default_all: false}
                        filter_type:
                            default_all: all
                            default_basic: all
                            default_1d: par_value
                            default_3d: par_value
                            enum: [sky_circle,
                                   angle_box,
                                   par_box,
                                   par_value,
                                   ids,
                                   all]
                        frame:
                            default_all: icrs
                            enum: [galactic, equatorial, icrs, fk5]
                        lon: {type: number, default_all: 83.633 deg}
                        lat: {type: number, default_all: 22.014 deg}
                        radius: {type: number, default_all: 0.5 deg}
                        border: {type: number, default_all: 0.5 deg}
                        variable:
                            type: string
                            default_all: TARGET_NAME
                            default_1d: TARGET_NAME
                            default_3d: TARGET_NAME
                        value_param:
                            type: string
                            default_all: Crab
                            default_1d: Crab
                            default_3d: Crab
                        value_range:
                            type: array
                            items: {type: number, default_all:[1 TeV, 100 TeV]}
                            minItems: 2
                            maxItems: 2
                        obs_ids:
                            type: array
                            items: {type: integer, default_all: [23523, 23526]}
                    required: [filter_type]
        required: [datastore, filters]

# Block: reduction
# Process of data reduction
#
#    Chosen data reducer process
#    data_reducer: 1d, 2d, 3d
#
#    Parameters used in the estimation of the background
#    Example values for the following properties
#    background:
#
#        background_estimator: reflected
#        on_region:
#            center:
#            - 83.633 deg
#            - 22.014 deg
#            frame: icrs
#            radius: 0.11 deg
#        exclusion_mask
#            filename: mask.fits
#            hdu: IMAGE
#
#    containment_correction: true
#
    reduction:
        type: object
        default_all: {}
        default_basic: {}
        default_1d: {}
        default_3d: {}
        additionalProperties: false
        properties:
            background:
                type: object
                default_all: {}
                default_1d: {}
                additionalProperties: false
                properties:
                    background_estimator:
                        default_all: reflected
                        default_1d: reflected
                        enum: [reflected, ring]
                    on_region:
                        type: object
                        default_all: {}
                        default_1d: {}
                        additionalProperties: false
                        properties:
                            center:
                                type: array
                                items: {type: number}
                                default_all: [83.633 deg, 22.014 deg]
                                default_1d: [83.633 deg, 22.014 deg]
                                minItems: 2
                                maxItems: 2
                            radius:
                                type: number
                                default_all: 0.1 deg
                                default_1d: 0.1 deg
                            frame:
                                default_all: icrs
                                default_1d: icrs
                                enum: [galactic, equatorial, icrs, fk5]
                    exclusion_mask:
                        type: object
                        default_all: {}
                        additionalProperties: false
                        properties:
                            filename: {type: string, default_all: mask.fits}
                            hdu: {type: string, default_all: IMAGE}
                if:
                    properties:
                        exclusion_mask:
                            required: [filename]
            data_reducer:
                default_all: 1d
                default_basic: not assigned
                default_1d: 1d
                default_3d: 3d
                enum: [not assigned, 1d, 2d, 3d]
            containment_correction: {type: boolean, default_all: false}
        if:
            properties:
                data_reducer:
                    const: 1d
        then:
            required: [background]
            properties:
                background:
                    required: [background_estimator, on_region]

# Block: geometry
# Geometry where to perform data reduction and analysis
#
#        Map pixel size in degrees
#        binsz: 0.02
#        Coordinate system
#        coordsys: CEL, GAL
#        Any valid WCS projection type
#        proj: CAR
#        Lon and lat in deg in the coordsys of the map
#        skydir: [83, 22]
#        Width of the map in degrees
#        width: [5, 5]
#        offset_max: 3 deg
#
#        Additional Map Axes other than spatial
#        Example values for energy axes
#        axes:
#            e_reco:
#                lo_bnd: 0.01
#                hi_bnd: 100
#                nbin: 73
#                unit: TeV
#                interp: log
#            e_true:
#                lo_bnd: 0.01
#                hi_bnd: 315
#                nbin: 109
#                unit: TeV
#                interp: log
#
    geometry:
        description: ""
        type: object
        default_all: {}
        default_basic: {}
        default_1d: {}
        default_3d: {}
        additionalProperties: false
        properties:
            binsz:
                type: number
                default_all: 0.02
                default_3d: 0.02
            coordsys:
                type: string
                default_all: CEL
                default_3d: CEL
                enum: [CEL, GAL]
            proj:
                type: string
                default_all: TAN
                default_3d: TAN
            skydir:
                type: array
                default_all: [83.633, 22.014]
                default_3d: [83.633, 22.014]
                items: {type: number}
                minItems: 2
                maxItems: 2
            width:
                type: array
                default_all: [5, 5]
                default_3d: [5, 5]
                items: {type: number}
                minItems: 1
                maxItems: 2
            offset_max:
                type: string
                default_all: 3 deg
                default_3d: 2.5 deg
            axes:
                type: object
                default_all: {}
                default_1d: {}
                default_3d: {}
                additionalProperties: false
                properties:
                    e_reco:
                        type: object
                        default_all: {}
                        default_3d: {}
                        additionalProperties: false
                        properties:
                            name:
                                type: string
                                default_all: e_reco
                                default_3d: energy
                            lo_bnd:
                                type: number
                                default_all: 0.01
                                default_3d: 1
                            hi_bnd:
                                type: number
                                default_all: 100
                                default_3d: 10
                            nbin:
                                type: number
                                default_all: 73
                                default_3d: 4
                            unit:
                                type: string
                                default_all: TeV
                                default_3d: TeV
                            interp:
                                type: string
                                default_all: log
                                default_3d: log
                                enum: [lin, log, sqrt]
                            node_type:
                                type: string
                                default_all: center
                                default_3d: center
                                enum: [edges, center]
                        required: [lo_bnd, hi_bnd, nbin, unit]
                    e_true:
                        type: object
                        default_all: {}
                        additionalProperties: false
                        properties:
                            name: {type: string, default_all: e_true}
                            lo_bnd: {type: number, default_all: 0.01}
                            hi_bnd: {type: number, default_all: 315}
                            nbin: {type: number, default_all: 109}
                            unit: {type: string, default_all: TeV}
                            interp:
                                type: string
                                default_all: log
                                enum: [lin, log, sqrt]
                            node_type:
                                type: string
                                default_all: center
                                enum: [edges, center]
                        required: [lo_bnd, hi_bnd, nbin, unit]

# Block: model
# Parameters that define the models used in the analysis process
# List of models with spatial and /or spectral components
# TODO
#
    model:
        type: object
        default_all: {}
        default_basic: {}
        default_1d: {}
        default_3d: {}
        additionalProperties: false
        properties:
            components:
                type: array
                default_all: [{}]
                default_basic: [{}]
                default_1d: [{}]
                default_3d: [{}]
                items:
                    type: object
                    additionalProperties: false
                    properties:
                        name:
                            type: string
                            default_all: source
                            default_1d: source
                        spatial:
                            type: object
                            default_all: {}
                            additionalProperties: false
                            properties:
                                type: {type: string, default_all: SkyGaussian}
                                parameters:
                                    type: array
                                    default_all:
                                        - factor: 0.0
                                          frozen: false
                                          max: 180.0
                                          min: -180.0
                                          name: lon_0
                                          scale: 1.0
                                          unit: deg
                                          value: 0.0
                                        - factor: 0.0
                                          frozen: false
                                          max: 90.0
                                          min: -90.0
                                          name: lat_0
                                          scale: 1.0
                                          unit: deg
                                          value: 0.0
                                        - factor: 1.0
                                          frozen: false
                                          max: .nan
                                          min: 0.0
                                          name: sigma
                                          scale: 1.0
                                          unit: deg
                                          value: 1.0
                                    items:
                                        type: object
                                        additionalProperties: false
                                        properties:
                                            name: {type: string}
                                            value: {type: number}
                                            factor: {type: number}
                                            scale: {type: number}
                                            unit: {type: string}
                                            min: {type: number}
                                            max: {type: number}
                                            frozen: {type: boolean}
                        spectral:
                            type: object
                            default_all: {}
                            default_basic: {}
                            default_1d: {}
                            additionalProperties: false
                            properties:
                                type:
                                    type: string
                                    default_all: PowerLaw
                                    default_1d: PowerLaw
                                parameters:
                                    type: array
                                    default_all:
                                        - factor: 2.0
                                          frozen: false
                                          max: .nan
                                          min: .nan
                                          name: index
                                          scale: 1.0
                                          unit: ''
                                          value: 2.0
                                        - factor: 1.0e-12
                                          frozen: false
                                          max: .nan
                                          min: .nan
                                          name: amplitude
                                          scale: 1.0
                                          unit: cm-2 s-1 TeV-1
                                          value: 1.0e-12
                                        - factor: 1.0
                                          frozen: true
                                          max: .nan
                                          min: .nan
                                          name: reference
                                          scale: 1.0
                                          unit: TeV
                                          value: 1.0
                                    default_basic:
                                        - factor: 2.0
                                          frozen: false
                                          max: .nan
                                          min: .nan
                                          name: index
                                          scale: 1.0
                                          unit: ''
                                          value: 2.0
                                        - factor: 1.0e-12
                                          frozen: false
                                          max: .nan
                                          min: .nan
                                          name: amplitude
                                          scale: 1.0
                                          unit: cm-2 s-1 TeV-1
                                          value: 1.0e-12
                                        - factor: 1.0
                                          frozen: true
                                          max: .nan
                                          min: .nan
                                          name: reference
                                          scale: 1.0
                                          unit: TeV
                                          value: 1.0
                                    default_1d:
                                        - factor: 2.0
                                          frozen: false
                                          max: .nan
                                          min: .nan
                                          name: index
                                          scale: 1.0
                                          unit: ''
                                          value: 2.0
                                        - factor: 1.0e-12
                                          frozen: false
                                          max: .nan
                                          min: .nan
                                          name: amplitude
                                          scale: 1.0
                                          unit: cm-2 s-1 TeV-1
                                          value: 1.0e-12
                                        - factor: 1.0
                                          frozen: true
                                          max: .nan
                                          min: .nan
                                          name: reference
                                          scale: 1.0
                                          unit: TeV
                                          value: 1.0
                                    items:
                                        type: object
                                        additionalProperties: false
                                        properties:
                                            name: {type: string}
                                            value: {type: number}
                                            factor: {type: number}
                                            scale: {type: number}
                                            unit: {type: string}
                                            min: {type: number}
                                            max: {type: number}
                                            frozen: {type: boolean}
# Block: fit
# Parameters that are used in the fitting process
#
#        Energy range considered, min and max values with units
#        fit_range:
#            min: 1 TeV
#            max: 100 Tev
#
    fit:
        type: object
        additionalProperties: false
        default_all: {}
        default_basic: {}
        default_1d: {}
        default_3d: {}
        properties:
            fit_range:
                type: object
                default_all: {}
                default_basic: {}
                default_1d: {}
                additionalProperties: false
                properties:
                    min:
                        type: number
                        default_all: 1 TeV
                        default_1d: 1 TeV
                    max:
                        type: number
                        default_all: 100 TeV
                        default_1d: 100 TeV
                dependencies:
                    min: [max]
                    max: [min]

# Block: flux
# Parameters that are used during the flux estimation process
#
#        Energy binning considered
#        fp_binning:
#            lo_bnd: 1
#            hi_bnd: 10
#            nbin: 11
#            unit: TeV
#            interp: log
#            node_type: edges
#
    flux:
        type: object
        additionalProperties: false
        default_all: {}
        default_basic: {}
        default_1d: {}
        default_3d: {}
        properties:
            fp_binning:
                type: object
                default_all:
                    lo_bnd: 1
                    hi_bnd: 10
                    nbin: 11
                    unit: TeV
                    interp: log
                default_1d:
                    lo_bnd: 1
                    hi_bnd: 10
                    nbin: 11
                    unit: TeV
                    interp: log
                additionalProperties: false
                properties:
                    name: {type: string}
                    lo_bnd: {type: number}
                    hi_bnd: {type: number}
                    nbin: {type: number}
                    unit: {type: string}
                    interp:
                        type: string
                        enum: [lin, log, sqrt]
                    node_type:
                        type: string
                        enum: [edges, center]
                required: [lo_bnd, hi_bnd, nbin, unit]

if:
    properties:
        reduction:
            properties:
                data_reducer:
                    const: 1d
then:
    properties:
        flux:
            required: [fp_binning]

required: [general, observations, reduction, model, fit, flux]
